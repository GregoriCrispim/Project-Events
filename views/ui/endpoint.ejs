<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= appName %> • <%= endpoint.title %></title>
    <meta name="color-scheme" content="dark light" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <link href="/public/ui.css" rel="stylesheet" />
  </head>
  <body>
    <header class="topbar">
      <div class="container-xl py-4">
        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-3">
            <a class="brand-mark text-decoration-none" href="/ui" title="Voltar">
              <i class="bi bi-arrow-left"></i>
            </a>
            <div>
              <div class="h5 mb-0 text-white"><%= endpoint.title %></div>
              <div class="text-white-50 small">
                <span class="pill mono"><%= endpoint.api.method %></span>
                <span class="pill mono"><%= endpoint.api.path %></span>
                <% if (endpoint.api.auth) { %><span class="pill pill-warn mono">JWT</span><% } %>
              </div>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <a class="btn btn-glass" href="/ui">
              <i class="bi bi-grid-1x2"></i>
              <span class="d-none d-sm-inline">Todas as rotas</span>
            </a>
            <button class="btn btn-glass" type="button" id="btnShowToken">
              <i class="bi bi-shield-check"></i>
              <span class="d-none d-sm-inline">Token</span>
              <span class="badge badge-soft ms-2 mono" id="tokenBadge">—</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="container-xl pb-5">
      <div class="row g-4 mt-1">
        <div class="col-12 col-lg-7">
          <div class="card card-glass">
            <div class="card-body">
              <% if (endpoint.description) { %>
                <div class="text-white-50 small mb-3"><%= endpoint.description %></div>
              <% } %>

              <form id="endpointForm" class="vstack gap-3" data-api-method="<%= endpoint.api.method %>" data-api-path="<%= endpoint.api.path %>" data-requires-auth="<%= endpoint.api.auth ? '1' : '0' %>" data-store-token-from="<%= endpoint.storeTokenFrom || '' %>">
                <% const pathFields = endpoint.fields.filter(f => f.where === 'path'); %>
                <% const bodyFields = endpoint.fields.filter(f => f.where === 'body'); %>

                <% if (pathFields.length) { %>
                  <div>
                    <div class="section-title">Parâmetros de URL</div>
                    <div class="row g-3 mt-1">
                      <% pathFields.forEach(f => { %>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-white-50"><%= f.label %></label>
                          <input class="form-control" name="<%= f.name %>" type="<%= f.type || 'text' %>" placeholder="<%= f.placeholder || '' %>" <%= f.required ? 'required' : '' %> />
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <% if (bodyFields.length) { %>
                  <div>
                    <div class="section-title">Dados (Body)</div>
                    <div class="row g-3 mt-1">
                      <% bodyFields.forEach(f => { %>
                        <div class="col-12 <%= f.type === 'textarea' ? '' : 'col-md-6' %>">
                          <label class="form-label small text-white-50"><%= f.label %></label>
                          <% if (f.type === 'textarea') { %>
                            <textarea class="form-control" name="<%= f.name %>" rows="4" placeholder="<%= f.placeholder || '' %>" <%= f.required ? 'required' : '' %>></textarea>
                          <% } else { %>
                            <input class="form-control" name="<%= f.name %>" type="<%= f.type || 'text' %>" placeholder="<%= f.placeholder || '' %>" <%= f.required ? 'required' : '' %> />
                          <% } %>
                        </div>
                      <% }); %>
                    </div>
                    <div class="form-text text-white-50 mt-2">
                      Campos vazios (não obrigatórios) não serão enviados.
                    </div>
                  </div>
                <% } %>

                <% if (!pathFields.length && !bodyFields.length) { %>
                  <div class="text-white-50 small">
                    Esta rota não exige parâmetros. Clique em <b>Executar</b>.
                  </div>
                <% } %>

                <div class="d-flex gap-2 flex-wrap align-items-center">
                  <button class="btn btn-success" type="submit" id="btnRun">
                    <i class="bi bi-play-fill"></i>
                    Executar
                  </button>
                  <a class="btn btn-outline-light" href="<%= endpoint.uiPath ? '/ui' + endpoint.uiPath : '/ui' %>">
                    <i class="bi bi-arrow-clockwise"></i>
                    Reset
                  </a>
                  <% if (endpoint.api.auth) { %>
                    <a class="btn btn-outline-light" href="/ui/auth/login">
                      <i class="bi bi-shield-lock"></i>
                      Fazer login
                    </a>
                  <% } %>
                  <span class="badge badge-soft mono" id="reqMeta">—</span>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-5">
          <div class="card card-glass">
            <div class="card-body">
              <div class="section-title">Dica rápida</div>
              <div class="text-white-50 small mt-2">
                - Rotas com <span class="pill pill-warn mono">JWT</span> exigem token no navegador.<br />
                - Use “Token” no topo para ver/limpar o token salvo.<br />
                - O retorno aparece em um modal em overlay, com JSON formatado.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal: Resposta -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content modal-glass">
          <div class="modal-header border-0">
            <h6 class="modal-title" id="resultTitle">Resposta</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span class="badge badge-soft mono" id="resultMeta">—</span>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-light" type="button" id="copyResult">
                  <i class="bi bi-clipboard"></i>
                  Copiar
                </button>
              </div>
            </div>
            <pre class="response-pre mono mt-3" id="resultBody">—</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Token -->
    <div class="modal fade" id="tokenModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-glass">
          <div class="modal-header border-0">
            <h6 class="modal-title">Token JWT</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <div class="text-white-50 small mb-2">O token fica salvo apenas no seu navegador (localStorage).</div>
            <textarea id="tokenValue" class="form-control mono" rows="6" spellcheck="false" placeholder="Faça login para gerar o token..."></textarea>
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
              <a class="btn btn-primary" href="/ui/auth/login">
                <i class="bi bi-shield-lock"></i>
                Ir para login
              </a>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-light" type="button" id="copyToken">
                  <i class="bi bi-clipboard"></i>
                  Copiar
                </button>
                <button class="btn btn-outline-danger" type="button" id="clearToken">
                  <i class="bi bi-trash3"></i>
                  Limpar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.__UI__ = <%- JSON.stringify({ page: 'endpoint' }) %>;
    </script>
    <script src="/public/ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>


